# 网络显示功能使用说明

## 功能概述

网络显示功能允许将板卡摄像头采集的图像实时传输到电脑上显示，方便远程查看和调试。

### 系统架构

```
┌─────────────────────┐          ┌─────────────────────┐
│  龙芯LS2K0300板卡   │          │    电脑 (Ubuntu)    │
│                     │          │                     │
│  USB摄像头          │          │                     │
│      ↓              │          │                     │
│  图像采集           │          │                     │
│      ↓              │          │                     │
│  IPS200屏幕显示     │          │                     │
│      ↓              │  TCP     │                     │
│  TCP服务器 ─────────┼─────────>│  Python客户端       │
│  (端口8888)         │  网络    │      ↓              │
│                     │          │  OpenCV窗口显示     │
└─────────────────────┘          └─────────────────────┘
```

## 快速开始

### 步骤1: 编译板卡程序（已完成）

程序已包含网络传输功能，无需额外操作。

```bash
# 如需重新编译
cd /home/cjw/ls2k0300_camera_project/application/camera_display
./build_simple.sh
```

### 步骤2: 传输到板卡

```bash
scp ../../output/camera_display_ips200 root@192.168.110.250:~/
```

### 步骤3: 在板卡上运行

```bash
ssh root@192.168.110.250
LD_LIBRARY_PATH=/home/root/opencv/lib ./camera_display_ips200
```

预期输出：
```
========================================
  USB摄像头 + IPS200屏幕 + 网络显示
  基于逐飞IPS200开源库实现
========================================

[1/3] 正在初始化 IPS200 屏幕...
IPS200屏幕初始化成功！

[2/3] 正在初始化 USB 摄像头...
USB摄像头初始化成功！

[3/3] 正在初始化网络流服务器...
网络流服务器启动成功，端口: 8888
等待电脑客户端连接...

开始采集并显示图像...
```

### 步骤4: 在电脑上安装依赖

```bash
# 安装Python依赖
pip3 install opencv-python numpy
```

### 步骤5: 运行电脑端客户端

```bash
cd /home/cjw/ls2k0300_camera_project/application/camera_display
python3 camera_viewer.py 192.168.110.250
```

预期输出：
```
============================================================
  LS2K0300 摄像头图像接收客户端
============================================================
板卡IP: 192.168.110.250
端口:   8888
============================================================
正在连接到板卡 192.168.110.250:8888...
连接成功！

开始接收图像...
按 'q' 或 ESC 键退出

帧率: 29.5 FPS, 总帧数: 30
```

此时会弹出OpenCV窗口实时显示摄像头图像。

## 网络配置

### 端口配置

默认使用TCP端口 **8888**。如需修改：

**板卡端** (`include/network_stream.h`):
```cpp
#define NETWORK_PORT 8888  // 修改为其他端口
```

**电脑端** (`camera_viewer.py`):
```python
NETWORK_PORT = 8888  # 修改为相同端口
```

### 最大客户端数

默认支持最多 **2个** 客户端同时连接。修改方法：

`include/network_stream.h`:
```cpp
#define MAX_CLIENTS 2  // 修改为需要的数量
```

## 使用技巧

### 1. 多客户端连接

可以同时运行多个Python客户端（最多2个）：

**终端1:**
```bash
python3 camera_viewer.py 192.168.110.250
```

**终端2:**
```bash
python3 camera_viewer.py 192.168.110.250
```

板卡会向所有连接的客户端同时发送图像。

### 2. 调整显示大小

默认图像放大4倍显示。修改 `camera_viewer.py` 中的缩放比例：

```python
# 第120行左右
display_frame = cv2.resize(frame, None, fx=4, fy=4, ...)  # 修改fx和fy
```

### 3. 保存图像

在Python客户端按键盘 's' 键可保存当前帧（需自行添加代码）：

```python
# 在camera_viewer.py的主循环中添加
if key == ord('s'):
    filename = f"capture_{int(time.time())}.png"
    cv2.imwrite(filename, frame)
    print(f"已保存: {filename}")
```

### 4. 录制视频

修改Python客户端添加视频录制功能（需自行实现）。

## 故障排查

### 问题1: 连接超时

**现象**: `连接失败: [Errno 111] Connection refused`

**解决方法**:
1. 确认板卡程序正在运行
2. 检查板卡IP地址是否正确
3. 检查网络连接（ping测试）
4. 检查防火墙设置

### 问题2: 图像花屏

**现象**: 显示的图像错位或花屏

**原因**: 网络数据包丢失或乱序

**解决方法**:
1. 检查网络质量（避免使用WiFi，改用有线网络）
2. 减少网络负载
3. 重启板卡端程序和客户端

### 问题3: 帧率低

**现象**: 显示的帧率远低于30 FPS

**可能原因**:
- 网络带宽不足
- 电脑性能不足
- 网络延迟高

**解决方法**:
1. 使用有线网络代替WiFi
2. 关闭其他占用网络的程序
3. 检查电脑CPU占用率

### 问题4: 无法连接多个客户端

**现象**: 第二个客户端无法连接

**解决方法**:
1. 检查 `MAX_CLIENTS` 配置
2. 确认第一个客户端没有占用多个连接
3. 重启板卡端程序

## 网络协议详解

### 数据包格式

每一帧图像通过一个完整的TCP数据包发送：

```
+----------------+------------------+
|  包头 (20字节) | 图像数据 (变长)  |
+----------------+------------------+
```

### 包头结构

使用C语言结构体定义（小端序）：

```c
struct ImageHeader {
    uint32_t magic;       // 0x12345678 - 魔数
    uint32_t width;       // 图像宽度 (例如: 160)
    uint32_t height;      // 图像高度 (例如: 120)
    uint32_t data_size;   // 数据大小 (width × height)
    uint32_t timestamp;   // 时间戳 (毫秒)
};
```

### 图像数据

- 格式：8位灰度图像
- 大小：width × height 字节
- 布局：逐行存储，从上到下，从左到右

### 传输示例

以160×120灰度图像为例：

1. 包头：20字节
   - magic: `0x12345678` (4字节)
   - width: `160` (4字节)
   - height: `120` (4字节)
   - data_size: `19200` (4字节, 160×120)
   - timestamp: 当前时间戳 (4字节)

2. 图像数据：19200字节（160×120像素）

3. 总大小：20 + 19200 = 19220 字节/帧

### 带宽计算

- 每帧数据：19220 字节
- 30 FPS：19220 × 30 = 576600 字节/秒 ≈ 563 KB/s ≈ 4.5 Mbps
- 建议网络带宽：≥ 10 Mbps（百兆网络完全够用）

## 性能优化

### 1. 网络优化

**使用有线网络**:
```bash
# 在板卡上检查网络接口
ifconfig eth0
```

**关闭不必要的网络服务**:
```bash
# 在板卡上
systemctl stop bluetooth
systemctl stop avahi-daemon
```

### 2. 降低分辨率提高帧率

修改 `include/uvc_camera.h`：
```cpp
// 更低分辨率 = 更高帧率 + 更小带宽
#define UVC_WIDTH  80
#define UVC_HEIGHT 60
```

### 3. 提高图像分辨率（降低帧率）

```cpp
// 更高分辨率 = 更清晰 + 更低帧率
#define UVC_WIDTH  320
#define UVC_HEIGHT 240
```

## 进阶功能

### 1. 添加图像压缩

可以在传输前对图像进行JPEG压缩以减少带宽（需自行实现）。

### 2. 添加加密

在敏感环境下可添加AES加密（需自行实现）。

### 3. 支持彩色图像

修改为传输RGB图像而非灰度图（需修改协议和代码）。

### 4. UDP传输

如果对丢帧不敏感，可改用UDP协议降低延迟（需修改代码）。

## 附录

### 文件清单

**板卡端：**
- `include/network_stream.h` - 网络流接口定义
- `src/network_stream.cpp` - 网络流实现
- `src/main.cpp` - 主程序（已集成网络流）

**电脑端：**
- `camera_viewer.py` - Python客户端程序

### 依赖库

**板卡端：**
- 标准C/C++库（socket, pthread等）

**电脑端：**
- Python 3.x
- opencv-python
- numpy

### 相关文档

- [README.md](README.md) - 项目总览
- [使用手册.md](使用手册.md) - 详细使用手册
- [项目整理说明.md](项目整理说明.md) - 项目整理记录

---

**文档版本**: 1.0
**最后更新**: 2025-11-08
**功能状态**: ✅ 已实现并测试
